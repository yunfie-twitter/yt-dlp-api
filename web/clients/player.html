<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player - yt-dlp-api</title>
    
    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #1a1a1a;
            padding: 1rem 2rem;
            border-bottom: 1px solid #2a2a2a;
        }
        
        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
        }
        
        .video-container {
            width: 100%;
            max-width: 1200px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .video-js {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 9;
        }
        
        .info-panel {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #1a1a1a;
            border-radius: 8px;
            width: 100%;
            max-width: 1200px;
        }
        
        .info-item {
            margin-bottom: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .info-item strong {
            color: #4a9eff;
            min-width: 120px;
        }
        
        .info-item span {
            color: #ccc;
            word-break: break-all;
        }
        
        .status {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }
        
        .status.loading {
            background: #1a3a5a;
            color: #4a9eff;
        }
        
        .status.error {
            background: #5a1a1a;
            color: #ff6b6b;
        }
        
        .status.success {
            background: #1a5a1a;
            color: #6bff6b;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #4a9eff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        footer {
            padding: 1rem 2rem;
            text-align: center;
            color: #666;
            border-top: 1px solid #2a2a2a;
        }
        
        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }
            
            main {
                padding: 1rem;
            }
            
            .info-item {
                flex-direction: column;
            }
            
            .info-item strong {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üé¨ Video Player</h1>
    </header>
    
    <main>
        <div id="status-container"></div>
        
        <div class="video-container" id="video-container" style="display: none;">
            <video
                id="video-player"
                class="video-js vjs-big-play-centered"
                controls
                preload="auto"
                data-setup='{}'>
            </video>
        </div>
        
        <div class="info-panel" id="info-panel" style="display: none;">
            <h3 style="margin-bottom: 1rem;">üìä ÂÜçÁîüÊÉÖÂ†±</h3>
            <div class="info-item">
                <strong>ÂÖÉURL:</strong>
                <span id="info-url">-</span>
            </div>
            <div class="info-item">
                <strong>„Éû„Éã„Éï„Çß„Çπ„Éà:</strong>
                <span id="info-manifest">-</span>
            </div>
            <div class="info-item">
                <strong>ÂÜçÁîüÊñπÂºè:</strong>
                <span id="info-method">-</span>
            </div>
        </div>
    </main>
    
    <footer>
        <p>Powered by yt-dlp-api | Video.js 8.10.0</p>
    </footer>
    
    <!-- Video.js -->
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    
    <script>
        // Get URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const videoUrl = urlParams.get('url');
        
        const statusContainer = document.getElementById('status-container');
        const videoContainer = document.getElementById('video-container');
        const infoPanel = document.getElementById('info-panel');
        
        function showStatus(message, type = 'loading') {
            const spinner = type === 'loading' ? '<span class="spinner"></span>' : '';
            statusContainer.innerHTML = `
                <div class="status ${type}">
                    ${spinner}${message}
                </div>
            `;
        }
        
        function hideStatus() {
            statusContainer.innerHTML = '';
        }
        
        function updateInfo(data) {
            document.getElementById('info-url').textContent = data.original_url || '-';
            document.getElementById('info-manifest').textContent = data.url || '-';
            document.getElementById('info-method').textContent = data.method || '-';
            infoPanel.style.display = 'block';
        }
        
        async function loadVideo() {
            if (!videoUrl) {
                showStatus('‚ùå URL„Éë„É©„É°„Éº„Çø„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ‰æã: ?url=https://youtube.com/watch?v=...', 'error');
                return;
            }
            
            try {
                showStatus('üîç ÂãïÁîªÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...', 'loading');
                
                // Get API base URL (same origin)
                const apiBase = window.location.origin;
                
                // Call /stream API
                const response = await fetch(`${apiBase}/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: videoUrl
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                showStatus('‚úÖ „Éû„Éã„Éï„Çß„Çπ„ÉàÂèñÂæóÊàêÂäüÔºÅÂÜçÁîüÊ∫ñÂÇô‰∏≠...', 'success');
                
                // Update info panel
                updateInfo(data);
                
                // Show video container
                videoContainer.style.display = 'block';
                
                // Initialize Video.js
                const player = videojs('video-player', {
                    controls: true,
                    autoplay: false,
                    preload: 'auto',
                    fluid: true,
                    responsive: true,
                    html5: {
                        vhs: {
                            overrideNative: true,
                            enableLowInitialPlaylist: true,
                        },
                        nativeAudioTracks: false,
                        nativeVideoTracks: false
                    }
                });
                
                // Set source
                player.src({
                    src: data.url,
                    type: 'application/x-mpegURL'
                });
                
                // Event handlers
                player.on('loadedmetadata', function() {
                    hideStatus();
                    console.log('‚úÖ Metadata loaded');
                });
                
                player.on('error', function(e) {
                    const error = player.error();
                    console.error('Video.js Error:', error);
                    showStatus(`‚ùå ÂÜçÁîü„Ç®„É©„Éº: ${error.message} (CODE: ${error.code})`, 'error');
                });
                
                player.on('playing', function() {
                    console.log('‚ñ∂Ô∏è Playing');
                });
                
                // Log for debugging
                console.log('Video.js initialized with:', data);
                
            } catch (error) {
                console.error('Load error:', error);
                showStatus(`‚ùå „Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }
        
        // Start loading when page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadVideo);
        } else {
            loadVideo();
        }
    </script>
</body>
</html>