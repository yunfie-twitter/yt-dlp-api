<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt-dlp Web Client</title>
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.13.1/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.13.1/dist/cdn/beer.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: row;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        
        .rail-nav {
            width: 80px;
            background: var(--surface-container);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
            gap: 0.5rem;
            border-right: 1px solid var(--outline-variant);
        }
        
        .rail-nav a {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: var(--on-surface);
        }
        
        .rail-nav a:hover {
            background: var(--surface-variant);
        }
        
        .rail-nav a.active {
            background: var(--secondary-container);
            color: var(--on-secondary-container);
        }
        
        .rail-nav a i {
            font-size: 24px;
        }
        
        .rail-nav a span {
            font-size: 12px;
            margin-top: 4px;
        }
        
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        header {
            flex-shrink: 0;
        }
        
        main {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 0;
        }
        
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface-container);
            border-top: 1px solid var(--outline-variant);
            z-index: 100;
        }
        
        .bottom-nav nav {
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
        }
        
        .bottom-nav a {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: var(--on-surface);
        }
        
        .bottom-nav a.active {
            background: var(--secondary-container);
            color: var(--on-secondary-container);
        }
        
        .bottom-nav a i {
            font-size: 24px;
        }
        
        .bottom-nav a span {
            font-size: 12px;
            margin-top: 4px;
        }
        
        @media (max-width: 768px) {
            .rail-nav {
                display: none;
            }
            
            .bottom-nav {
                display: block;
            }
            
            main {
                padding-bottom: 80px;
            }
        }
        
        .thumbnail-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-info-card {
            margin-top: 1rem;
        }
        .quality-selector {
            margin: 1rem 0;
        }
        .download-progress {
            display: inline-block;
            margin-left: 0.5rem;
        }
        .progress-card {
            margin-top: 1rem;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--surface-variant);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        .history-item {
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 0.5rem;
        }
        .history-item:hover {
            background: rgba(255,255,255,0.1);
        }
        .history-thumbnail {
            width: 120px;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 1rem;
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        .modal-overlay.active {
            display: block;
        }
        dialog.active {
            z-index: 1000;
        }
        .menu-divider {
            height: 1px;
            background: var(--outline-variant);
            margin: 0.5rem 0;
        }
    </style>
</head>
<body class="dark">
    <div id="app" style="display: flex; width: 100%; height: 100%;">
        <div class="rail-nav">
            <a @click="navigateToPage('home')" :class="{ active: currentPage === 'home' }">
                <i>home</i>
                <span>ホーム</span>
            </a>
            <a @click="navigateToPage('history')" :class="{ active: currentPage === 'history' }">
                <i>history</i>
                <span>履歴</span>
            </a>
            <div style="flex: 1;"></div>
            <a href="https://github.com/yunfie-twitter/yt-dlp-api" target="_blank">
                <i>code</i>
                <span>GitHub</span>
            </a>
            <a @click="toggleThemeManual">
                <i>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</i>
                <span>テーマ</span>
            </a>
        </div>

        <div class="main-container">
            <header>
                <nav>
                    <h6 class="max">yt-dlp Web Client</h6>
                    <button class="circle transparent" data-ui="#settings-menu">
                        <i>settings</i>
                    </button>
                    <menu id="settings-menu">
                        <ul class="list border">
                            <li @click="toggleThemeManual">
                                <i>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</i>
                                <span>{{ isDarkMode ? 'ライトモード' : 'ダークモード' }}</span>
                            </li>
                            <div class="menu-divider"></div>
                            <li>
                                <a href="https://github.com/yunfie-twitter/yt-dlp-api" target="_blank" style="color: inherit; text-decoration: none; display: flex; align-items: center;">
                                    <i>code</i>
                                    <span>GitHub リポジトリ</span>
                                </a>
                            </li>
                            <div class="menu-divider"></div>
                            <li>
                                <i>info</i>
                                <span>バージョン 2.0.0</span>
                            </li>
                        </ul>
                    </menu>
                </nav>
            </header>

            <main class="responsive">
                <div class="space"></div>

                <div v-if="currentPage === 'home'">
                    <article class="border">
                        <div class="padding">
                            <h6>動画URLを入力</h6>
                            <div class="field label border">
                                <input v-model="url" @keyup.enter="fetchInfo" type="text" :disabled="loading">
                                <label>YouTube, ニコニコ動画, Twitter など</label>
                            </div>
                            <nav class="right-align">
                                <button @click="pasteFromClipboard" :disabled="loading" class="primary">
                                    <i>content_paste</i>
                                    <span>貼り付け</span>
                                </button>
                                <button @click="fetchInfo" :disabled="loading || !url" class="primary">
                                    <i>search</i>
                                    <span>解析</span>
                                    <progress v-if="loading" class="circle small download-progress"></progress>
                                </button>
                            </nav>
                            <div v-if="error" class="small-padding">
                                <article class="red-border round">
                                    <i>error</i>
                                    <p>{{ error }}</p>
                                </article>
                            </div>
                        </div>
                    </article>

                    <article v-if="info" class="border video-info-card">
                        <div class="grid">
                            <div class="s12 m4">
                                <div class="thumbnail-container">
                                    <img :src="info.thumbnail" :alt="info.title">
                                </div>
                            </div>
                            <div class="s12 m8">
                                <div class="padding">
                                    <h6 class="small">{{ info.title }}</h6>
                                    <p class="small-margin">
                                        <i>person</i>
                                        <span>{{ info.uploader || 'Unknown' }}</span>
                                    </p>
                                    <div class="row small-margin">
                                        <i>schedule</i>
                                        <span>{{ formatDuration(info.duration) }}</span>
                                        <span class="small-margin"> • </span>
                                        <i>visibility</i>
                                        <span>{{ info.view_count?.toLocaleString() || '0' }} views</span>
                                    </div>

                                    <div class="field suffix border quality-selector">
                                        <select v-model="selectedQuality">
                                            <option value="">最高画質 (Best)</option>
                                            <option value="1080">1080p</option>
                                            <option value="720">720p</option>
                                            <option value="480">480p</option>
                                            <option value="audio">音声のみ (Audio)</option>
                                        </select>
                                        <i>high_quality</i>
                                    </div>

                                    <nav>
                                        <button @click="download" :disabled="downloading" class="responsive primary">
                                            <i>download</i>
                                            <span>ダウンロード</span>
                                            <progress v-if="downloading" class="circle small download-progress"></progress>
                                        </button>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </article>

                    <!-- Progress Card -->
                    <article v-if="downloadProgress" class="border progress-card">
                        <div class="padding">
                            <div class="row">
                                <div class="max">
                                    <h6>ダウンロード中</h6>
                                    <p class="small">{{ downloadProgress.filename || '処理中...' }}</p>
                                </div>
                                <i v-if="downloadProgress.status === 'completed'" class="green-text">check_circle</i>
                                <progress v-else-if="downloadProgress.status === 'downloading'" class="circle"></progress>
                            </div>
                            
                            <div class="progress-bar">
                                <div class="progress-bar-fill" :style="{ width: downloadProgress.progress + '%' }"></div>
                            </div>
                            
                            <div class="row small">
                                <span class="max">{{ downloadProgress.progress?.toFixed(1) || 0 }}%</span>
                                <span v-if="downloadProgress.speed">{{ downloadProgress.speed }}</span>
                                <span v-if="downloadProgress.eta" class="small-margin">ETA {{ downloadProgress.eta }}</span>
                            </div>
                            
                            <p v-if="downloadProgress.message" class="small center-align">
                                {{ downloadProgress.message }}
                            </p>
                        </div>
                    </article>
                </div>

                <div v-if="currentPage === 'history'">
                    <article class="border">
                        <div class="padding">
                            <div class="row">
                                <h5 class="max">ダウンロード履歴</h5>
                                <button @click="confirmClearHistory" class="primary" :disabled="history.length === 0">
                                    <i>delete_sweep</i>
                                    <span>クリア</span>
                                </button>
                            </div>
                        </div>
                    </article>

                    <div v-if="history.length === 0" class="padding">
                        <article class="border center-align">
                            <div class="padding">
                                <i class="extra">history</i>
                                <p>履歴がありません</p>
                                <button @click="navigateToPage('home')" class="primary">
                                    <i>home</i>
                                    <span>ホームに戻る</span>
                                </button>
                            </div>
                        </article>
                    </div>

                    <article v-else v-for="(item, index) in history" :key="index" class="border history-item" @click="loadFromHistory(item)">
                        <div class="row padding">
                            <img :src="item.thumbnail" class="history-thumbnail" :alt="item.title">
                            <div class="max">
                                <p class="bold">{{ item.title }}</p>
                                <p class="small">
                                    <i>person</i>
                                    {{ item.uploader }}
                                </p>
                                <p class="small">
                                    <i>schedule</i>
                                    {{ new Date(item.timestamp).toLocaleString('ja-JP') }}
                                </p>
                            </div>
                            <i>download</i>
                        </div>
                    </article>
                </div>

                <div class="space"></div>
            </main>
        </div>

        <div class="bottom-nav">
            <nav>
                <a @click="navigateToPage('home')" :class="{ active: currentPage === 'home' }">
                    <i>home</i>
                    <span>ホーム</span>
                </a>
                <a @click="navigateToPage('history')" :class="{ active: currentPage === 'history' }">
                    <i>history</i>
                    <span>履歴</span>
                </a>
                <a href="https://github.com/yunfie-twitter/yt-dlp-api" target="_blank">
                    <i>code</i>
                    <span>GitHub</span>
                </a>
                <a @click="toggleThemeManual">
                    <i>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</i>
                    <span>テーマ</span>
                </a>
            </nav>
        </div>

        <div class="modal-overlay" :class="{ active: showDeleteModal }" @click="showDeleteModal = false"></div>

        <dialog :class="{ active: showDeleteModal }">
            <h5>履歴を削除</h5>
            <p>すべてのダウンロード履歴を削除しますか?</p>
            <nav class="right-align">
                <button @click="showDeleteModal = false" class="border">キャンセル</button>
                <button @click="clearHistory" class="primary">削除</button>
            </nav>
        </dialog>
    </div>

    <script>
        const { createApp, ref, onMounted, onUnmounted } = Vue

        createApp({
            setup() {
                const url = ref('')
                const info = ref(null)
                const loading = ref(false)
                const downloading = ref(false)
                const error = ref(null)
                const selectedQuality = ref('')
                const currentPage = ref('home')
                const showDeleteModal = ref(false)
                const history = ref([])
                const isDarkMode = ref(true)
                const downloadProgress = ref(null)
                const websocket = ref(null)
                const currentTaskId = ref(null)

                const setCookie = (name, value, days = 365) => {
                    const expires = new Date()
                    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000)
                    document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))};expires=${expires.toUTCString()};path=/`
                }

                const getCookie = (name) => {
                    const nameEQ = name + '='
                    const ca = document.cookie.split(';')
                    for (let i = 0; i < ca.length; i++) {
                        let c = ca[i]
                        while (c.charAt(0) === ' ') c = c.substring(1, c.length)
                        if (c.indexOf(nameEQ) === 0) {
                            return JSON.parse(decodeURIComponent(c.substring(nameEQ.length, c.length)))
                        }
                    }
                    return null
                }

                const loadHistory = () => {
                    const saved = getCookie('downloadHistory')
                    if (saved) {
                        history.value = saved
                    }
                }

                const saveToHistory = (videoInfo) => {
                    const historyItem = {
                        url: url.value,
                        title: videoInfo.title,
                        thumbnail: videoInfo.thumbnail,
                        uploader: videoInfo.uploader,
                        timestamp: Date.now()
                    }
                    history.value.unshift(historyItem)
                    if (history.value.length > 20) {
                        history.value = history.value.slice(0, 20)
                    }
                    setCookie('downloadHistory', history.value)
                }

                const confirmClearHistory = () => {
                    showDeleteModal.value = true
                }

                const clearHistory = () => {
                    history.value = []
                    setCookie('downloadHistory', [])
                    showDeleteModal.value = false
                }

                const loadFromHistory = (item) => {
                    url.value = item.url
                    currentPage.value = 'home'
                    fetchInfo()
                }

                const navigateToPage = (page) => {
                    currentPage.value = page
                }

                const toggleThemeManual = () => {
                    isDarkMode.value = !isDarkMode.value
                    if (isDarkMode.value) {
                        document.body.classList.add('dark')
                        document.body.classList.remove('light')
                    } else {
                        document.body.classList.add('light')
                        document.body.classList.remove('dark')
                    }
                }

                const pasteFromClipboard = async () => {
                    try {
                        const text = await navigator.clipboard.readText()
                        url.value = text
                    } catch (e) {
                        error.value = 'クリップボードからの読み取りに失敗しました'
                    }
                }

                const fetchInfo = async () => {
                    if (!url.value) return
                    loading.value = true
                    error.value = null
                    info.value = null
                    
                    try {
                        const res = await fetch('/info', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: url.value })
                        })
                        if (!res.ok) {
                            const errorData = await res.json()
                            throw new Error(errorData.detail || '情報の取得に失敗しました')
                        }
                        info.value = await res.json()
                    } catch (e) {
                        error.value = e.message
                    } finally {
                        loading.value = false
                    }
                }

                const formatDuration = (seconds) => {
                    if (!seconds) return 'Live'
                    const h = Math.floor(seconds / 3600)
                    const m = Math.floor((seconds % 3600) / 60)
                    const s = seconds % 60
                    return h > 0 
                        ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`
                        : `${m}:${s.toString().padStart(2, '0')}`
                }

                const connectWebSocket = (taskId) => {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
                    const wsUrl = `${protocol}//${window.location.host}/download/progress/ws/${taskId}`
                    
                    websocket.value = new WebSocket(wsUrl)
                    
                    websocket.value.onopen = () => {
                        console.log('WebSocket connected')
                        // Send ping every 30 seconds to keep connection alive
                        const pingInterval = setInterval(() => {
                            if (websocket.value?.readyState === WebSocket.OPEN) {
                                websocket.value.send('ping')
                            } else {
                                clearInterval(pingInterval)
                            }
                        }, 30000)
                    }
                    
                    websocket.value.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data)
                            downloadProgress.value = data
                            
                            // When download completes, trigger browser download
                            if (data.status === 'completed') {
                                setTimeout(() => {
                                    triggerBrowserDownload(taskId)
                                }, 500)
                            }
                        } catch (e) {
                            console.error('WebSocket message parse error:', e)
                        }
                    }
                    
                    websocket.value.onerror = (error) => {
                        console.error('WebSocket error:', error)
                    }
                    
                    websocket.value.onclose = () => {
                        console.log('WebSocket disconnected')
                    }
                }

                const triggerBrowserDownload = (taskId) => {
                    // Create a hidden link and trigger browser's native download
                    const a = document.createElement('a')
                    a.href = `/download/file/${taskId}`
                    a.style.display = 'none'
                    document.body.appendChild(a)
                    a.click()
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(a)
                        downloadProgress.value = null
                        downloading.value = false
                        currentTaskId.value = null
                        
                        // Save to history
                        if (info.value) {
                            saveToHistory(info.value)
                        }
                    }, 1000)
                }

                const download = async () => {
                    if (!info.value) return
                    downloading.value = true
                    error.value = null
                    downloadProgress.value = {
                        status: 'queued',
                        progress: 0,
                        message: 'ダウンロードを開始しています...'
                    }
                    
                    try {
                        const payload = { url: url.value }
                        if (selectedQuality.value === 'audio') {
                            payload.audio_format = 'mp3'
                        } else if (selectedQuality.value) {
                            payload.quality = parseInt(selectedQuality.value)
                        }
                        
                        // Start download task
                        const res = await fetch('/download/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        
                        if (!res.ok) throw new Error('ダウンロードの開始に失敗しました')
                        
                        const data = await res.json()
                        currentTaskId.value = data.task_id
                        
                        // Connect WebSocket for progress updates
                        connectWebSocket(data.task_id)
                        
                    } catch (e) {
                        error.value = e.message
                        downloading.value = false
                        downloadProgress.value = null
                    }
                }

                onUnmounted(() => {
                    // Close WebSocket on component unmount
                    if (websocket.value) {
                        websocket.value.close()
                    }
                })

                onMounted(() => {
                    loadHistory()
                })

                return {
                    url, info, loading, downloading, error, selectedQuality,
                    currentPage, showDeleteModal, history, isDarkMode, downloadProgress,
                    fetchInfo, formatDuration, download, navigateToPage,
                    pasteFromClipboard, confirmClearHistory, clearHistory, loadFromHistory, toggleThemeManual
                }
            }
        }).mount('#app')
    </script>
</body>
</html>