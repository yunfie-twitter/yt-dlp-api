<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt-dlp Web Client</title>
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.13.1/dist/cdn/beer.min.css" rel="stylesheet">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.13.1/dist/cdn/beer.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <style>
        .video-container {
            max-width: 100%;
            margin: 1rem 0;
        }
        .thumbnail-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
        }
        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .play-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            opacity: 0;
            transition: opacity 0.3s;
            cursor: pointer;
        }
        .thumbnail-container:hover .play-overlay {
            opacity: 1;
        }
        .video-info-card {
            margin-top: 1rem;
        }
        .quality-selector {
            margin: 1rem 0;
        }
    </style>
</head>
<body class="dark">
    <div id="app">
        <nav class="primary">
            <h5 class="max">yt-dlp Web Client</h5>
            <button class="circle transparent">
                <i>dark_mode</i>
            </button>
        </nav>

        <main class="responsive">
            <div class="space"></div>

            <!-- Input Section -->
            <article class="border">
                <div class="padding">
                    <h6>動画URLを入力</h6>
                    <div class="field label border">
                        <input v-model="url" @keyup.enter="fetchInfo" type="text" :disabled="loading">
                        <label>YouTube, ニコニコ動画, Twitter など</label>
                    </div>
                    <nav class="right-align">
                        <button @click="fetchInfo" :disabled="loading || !url" class="primary">
                            <i>{{ loading ? 'progress_activity' : 'search' }}</i>
                            <span>{{ loading ? '取得中...' : '解析' }}</span>
                        </button>
                    </nav>
                    <div v-if="error" class="small-padding">
                        <article class="red-border round">
                            <i>error</i>
                            <p>{{ error }}</p>
                        </article>
                    </div>
                </div>
            </article>

            <!-- Result Section -->
            <article v-if="info" class="border video-info-card">
                <div class="grid">
                    <div class="s12 m4">
                        <div class="thumbnail-container">
                            <img :src="info.thumbnail" :alt="info.title">
                            <div class="play-overlay" @click="playVideo">
                                <i class="extra">play_circle</i>
                            </div>
                        </div>
                    </div>
                    <div class="s12 m8">
                        <div class="padding">
                            <h6 class="small">{{ info.title }}</h6>
                            <p class="small-margin">
                                <i>person</i>
                                <span>{{ info.uploader || 'Unknown' }}</span>
                            </p>
                            <div class="row small-margin">
                                <i>schedule</i>
                                <span>{{ formatDuration(info.duration) }}</span>
                                <span class="small-margin"> • </span>
                                <i>visibility</i>
                                <span>{{ info.view_count?.toLocaleString() || '0' }} views</span>
                            </div>

                            <!-- Quality Selection -->
                            <div class="field suffix border quality-selector">
                                <select v-model="selectedQuality">
                                    <option value="">最高画質 (Best)</option>
                                    <option value="1080">1080p</option>
                                    <option value="720">720p</option>
                                    <option value="480">480p</option>
                                    <option value="audio">音声のみ (Audio)</option>
                                </select>
                                <i>high_quality</i>
                            </div>

                            <!-- Action Buttons -->
                            <nav>
                                <button @click="download" class="responsive green">
                                    <i>download</i>
                                    <span>ダウンロード</span>
                                </button>
                                <button @click="playVideo" class="responsive purple">
                                    <i>play_arrow</i>
                                    <span>ストリーミング再生</span>
                                </button>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Video Player -->
                <div v-show="showPlayer" class="padding video-container">
                    <video ref="videoPlayer" class="video-js vjs-big-play-centered vjs-theme-city responsive" controls preload="auto"></video>
                    <article class="small-margin round">
                        <p class="small">Stream URL: {{ streamUrl }}</p>
                    </article>
                </div>
            </article>

            <div class="space"></div>
        </main>

        <!-- Progress Indicator -->
        <div v-if="loading" class="overlay active">
            <div class="center-align middle-align">
                <progress class="circle large"></progress>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue

        createApp({
            setup() {
                const url = ref('')
                const info = ref(null)
                const loading = ref(false)
                const error = ref(null)
                const selectedQuality = ref('')
                const showPlayer = ref(false)
                const videoPlayer = ref(null)
                const streamUrl = ref('')
                let player = null

                const fetchInfo = async () => {
                    if (!url.value) return
                    loading.value = true
                    error.value = null
                    info.value = null
                    showPlayer.value = false
                    
                    try {
                        const res = await fetch('/info', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: url.value })
                        })
                        if (!res.ok) {
                            const errorData = await res.json()
                            throw new Error(errorData.detail || '情報の取得に失敗しました')
                        }
                        info.value = await res.json()
                    } catch (e) {
                        error.value = e.message
                    } finally {
                        loading.value = false
                    }
                }

                const formatDuration = (seconds) => {
                    if (!seconds) return 'Live'
                    const h = Math.floor(seconds / 3600)
                    const m = Math.floor((seconds % 3600) / 60)
                    const s = seconds % 60
                    return h > 0 
                        ? `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`
                        : `${m}:${s.toString().padStart(2, '0')}`
                }

                const download = async () => {
                    if (!info.value) return
                    loading.value = true
                    try {
                        const payload = {
                            url: url.value
                        }
                        if (selectedQuality.value === 'audio') {
                            payload.audio_format = 'mp3'
                        } else if (selectedQuality.value) {
                            payload.quality = parseInt(selectedQuality.value)
                        }
                        
                        const res = await fetch('/download', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        })
                        
                        if (!res.ok) throw new Error('ダウンロードに失敗しました')
                        
                        const blob = await res.blob()
                        const downloadUrl = window.URL.createObjectURL(blob)
                        const a = document.createElement('a')
                        a.href = downloadUrl
                        a.download = `${info.value.title || 'video'}.${selectedQuality.value === 'audio' ? 'mp3' : 'mp4'}`
                        document.body.appendChild(a)
                        a.click()
                        window.URL.revokeObjectURL(downloadUrl)
                        document.body.removeChild(a)
                    } catch (e) {
                        error.value = e.message
                    } finally {
                        loading.value = false
                    }
                }

                const playVideo = async () => {
                    if (!info.value) return
                    showPlayer.value = true
                    loading.value = true
                    
                    try {
                        const res = await fetch('/stream', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: url.value })
                        })
                        if (!res.ok) throw new Error('ストリームの取得に失敗しました')
                        const data = await res.json()
                        streamUrl.value = data.url
                        
                        if (player) player.dispose()
                        
                        setTimeout(() => {
                            player = videojs(videoPlayer.value, {
                                fluid: true,
                                html5: {
                                    hls: {
                                        overrideNative: true
                                    }
                                }
                            })
                            player.src({
                                src: streamUrl.value,
                                type: 'application/x-mpegURL'
                            })
                            player.play()
                        }, 100)

                    } catch (e) {
                        error.value = e.message
                    } finally {
                        loading.value = false
                    }
                }

                return {
                    url, info, loading, error, selectedQuality,
                    fetchInfo, formatDuration, download, playVideo,
                    showPlayer, videoPlayer, streamUrl
                }
            }
        }).mount('#app')
    </script>
</body>
</html>