<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt-dlp Web Client</title>
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/beercss@3.13.1/dist/cdn/beer.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body class="dark">
    <div id="app" style="display: flex; width: 100%; height: 100%;">
        <!-- Rail Navigation -->
        <div class="rail-nav">
            <a @click="navigateToPage('home')" :class="{ active: currentPage === 'home' }">
                <i>home</i>
                <span>ホーム</span>
            </a>
            <a @click="navigateToPage('history')" :class="{ active: currentPage === 'history' }">
                <i>history</i>
                <span>履歴</span>
            </a>
            <div style="flex: 1;"></div>
            <a href="https://github.com/yunfie-twitter/yt-dlp-api" target="_blank">
                <i>code</i>
                <span>GitHub</span>
            </a>
            <a @click="toggleThemeManual">
                <i>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</i>
                <span>テーマ</span>
            </a>
        </div>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Header -->
            <header>
                <nav>
                    <h6 class="max">yt-dlp Web Client</h6>
                    <button class="circle transparent" @click="showSettingsModal = true">
                        <i>settings</i>
                    </button>
                </nav>
            </header>

            <main class="responsive">
                <div class="space"></div>

                <!-- Home Page -->
                <div v-if="currentPage === 'home'" class="page-enter-active">
                    <article class="border">
                        <div class="padding">
                            <h6>動画URLを入力</h6>
                            <div class="field label border">
                                <input v-model="url" @keyup.enter="fetchInfo" type="text" :disabled="loading">
                                <label>YouTube, ニコニコ動画, Twitter など</label>
                            </div>
                            <nav class="right-align">
                                <button @click="addRipple($event); pasteFromClipboard()" :disabled="loading" class="primary">
                                    <i>content_paste</i>
                                    <span>貼り付け</span>
                                </button>
                                <button @click="addRipple($event); fetchInfo()" :disabled="loading || !url" class="primary">
                                    <i>search</i>
                                    <span>解析</span>
                                    <progress v-if="loading" class="circle small download-progress"></progress>
                                </button>
                            </nav>
                            <div v-if="error" class="small-padding error-enter-active">
                                <article class="red-border round">
                                    <i>error</i>
                                    <p>{{ error }}</p>
                                </article>
                            </div>
                        </div>
                    </article>

                    <article v-if="info" class="border video-info-card">
                        <div class="grid">
                            <div class="s12 m4">
                                <div class="thumbnail-container">
                                    <img :src="info.thumbnail" :alt="info.title">
                                    <div class="thumbnail-overlay" v-if="info.duration">
                                        {{ formatDuration(info.duration) }}
                                    </div>
                                    <div class="thumbnail-overlay" v-else>
                                        LIVE
                                    </div>
                                </div>
                            </div>
                            <div class="s12 m8">
                                <div class="padding">
                                    <h6 class="small">{{ info.title }}</h6>
                                    <div class="video-meta">
                                        <i>person</i>
                                        <span>{{ info.uploader || 'Unknown' }}</span>
                                    </div>
                                    <div class="video-meta">
                                        <i>visibility</i>
                                        <span>{{ info.view_count?.toLocaleString() || '0' }} views</span>
                                    </div>

                                    <div class="field suffix border quality-selector">
                                        <select v-model="selectedQuality">
                                            <option value="">最高画質 (Best)</option>
                                            <option v-for="quality in availableQualities" :key="quality" :value="quality">{{ quality }}p</option>
                                            <option value="audio">音声のみ (Audio)</option>
                                        </select>
                                        <i>high_quality</i>
                                    </div>

                                    <nav>
                                        <button @click="addRipple($event); download()" :disabled="downloading" class="responsive primary">
                                            <i>download</i>
                                            <span>ダウンロード</span>
                                            <progress v-if="downloading" class="circle small download-progress"></progress>
                                        </button>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>

                <!-- History Page -->
                <div v-if="currentPage === 'history'" class="page-enter-active">
                    <article class="border">
                        <div class="padding">
                            <div class="row">
                                <h5 class="max">ダウンロード履歴</h5>
                                <button @click="addRipple($event); confirmClearHistory()" class="primary" :disabled="history.length === 0">
                                    <i>delete_sweep</i>
                                    <span>クリア</span>
                                </button>
                            </div>
                        </div>
                    </article>

                    <div v-if="history.length === 0" class="padding">
                        <article class="border center-align">
                            <div class="padding">
                                <i class="extra">history</i>
                                <p>履歴がありません</p>
                                <button @click="addRipple($event); navigateToPage('home')" class="primary">
                                    <i>home</i>
                                    <span>ホームに戻る</span>
                                </button>
                            </div>
                        </article>
                    </div>

                    <article v-else v-for="(item, index) in history" :key="index" class="border history-item">
                        <div class="row padding" @click="loadFromHistory(item)">
                            <img :src="item.thumbnail" class="history-thumbnail" :alt="item.title">
                            <div class="max">
                                <p class="bold">{{ item.title }}</p>
                                <p class="small">
                                    <i>person</i>
                                    {{ item.uploader }}
                                </p>
                                <p class="small">
                                    <i>schedule</i>
                                    {{ formatTimestamp(item.timestamp) }}
                                </p>
                            </div>
                            <button @click.stop="addRipple($event); deleteHistoryItem(index)" class="circle transparent history-delete">
                                <i>delete</i>
                            </button>
                        </div>
                    </article>
                </div>

                <div class="space"></div>
            </main>

            <!-- Download Progress Footer -->
            <footer v-if="downloadProgress">
                <nav>
                    <button class="circle transparent" v-if="downloadProgress.status === 'completed'">
                        <i class="green-text">check_circle</i>
                    </button>
                    <button class="circle transparent" v-else-if="downloadProgress.status === 'downloading'">
                        <progress class="circle small"></progress>
                    </button>
                    <button class="circle transparent" v-else>
                        <i>downloading</i>
                    </button>
                    
                    <div class="progress-info">
                        <div class="progress-text">
                            <strong>{{ downloadProgress.filename || '処理中...' }}</strong>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" :style="{ width: downloadProgress.progress + '%' }"></div>
                        </div>
                        <div class="progress-stats">
                            <span>{{ downloadProgress.progress?.toFixed(1) || 0 }}%</span>
                            <span v-if="downloadProgress.speed">・ {{ downloadProgress.speed }}</span>
                            <span v-if="downloadProgress.eta">・ ETA {{ downloadProgress.eta }}</span>
                            <span v-if="downloadProgress.message">・ {{ downloadProgress.message }}</span>
                        </div>
                    </div>
                    
                    <div class="max"></div>
                    
                    <button 
                        v-if="downloadProgress.status === 'downloading' || downloadProgress.status === 'queued' || downloadProgress.status === 'fetching_info'"
                        @click="addRipple($event); cancelDownload()" 
                        class="circle transparent"
                        :disabled="downloadProgress.status === 'cancelling'"
                        title="キャンセル">
                        <i>close</i>
                    </button>
                </nav>
            </footer>
        </div>

        <!-- Bottom Navigation (Mobile) -->
        <div class="bottom-nav">
            <nav>
                <a @click="navigateToPage('home')" :class="{ active: currentPage === 'home' }">
                    <i>home</i>
                    <span>ホーム</span>
                </a>
                <a @click="navigateToPage('history')" :class="{ active: currentPage === 'history' }">
                    <i>history</i>
                    <span>履歴</span>
                </a>
                <a href="https://github.com/yunfie-twitter/yt-dlp-api" target="_blank">
                    <i>code</i>
                    <span>GitHub</span>
                </a>
                <a @click="toggleThemeManual">
                    <i>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</i>
                    <span>テーマ</span>
                </a>
            </nav>
        </div>

        <!-- Modal Overlays -->
        <div class="modal-overlay" :class="{ active: showDeleteModal }" @click="showDeleteModal = false"></div>
        <div class="modal-overlay" :class="{ active: showSettingsModal }" @click="showSettingsModal = false"></div>

        <!-- Delete Confirmation Dialog -->
        <dialog :class="{ active: showDeleteModal }">
            <button class="modal-close circle transparent" @click="showDeleteModal = false">
                <i>close</i>
            </button>
            <h5>履歴を削除</h5>
            <p>すべてのダウンロード履歴を削除しますか?</p>
            <nav class="right-align">
                <button @click="addRipple($event); showDeleteModal = false" class="border">キャンセル</button>
                <button @click="addRipple($event); clearHistory()" class="primary">削除</button>
            </nav>
        </dialog>

        <!-- Settings Dialog -->
        <dialog :class="{ active: showSettingsModal }" style="min-width: 400px; max-width: 500px;">
            <button class="modal-close circle transparent" @click="showSettingsModal = false">
                <i>close</i>
            </button>
            <h5 style="margin-bottom: 1.5rem;">設定</h5>
            
            <div class="settings-item">
                <div class="row">
                    <div class="max">
                        <h6>外観</h6>
                        <p class="small" style="margin-top: 0.5rem; color: var(--on-surface-variant);">テーマを変更</p>
                    </div>
                    <label class="switch">
                        <input type="checkbox" :checked="isDarkMode" @change="toggleTheme">
                        <span></span>
                    </label>
                </div>
                <p class="small">
                    <i>{{ isDarkMode ? 'dark_mode' : 'light_mode' }}</i>
                    <span>{{ isDarkMode ? 'ダークモード' : 'ライトモード' }}</span>
                </p>
            </div>

            <div class="settings-item">
                <h6>情報</h6>
                <p class="small">
                    <i>info</i>
                    <span>バージョン 2.1.0</span>
                </p>
                <p class="small">
                    <i>code</i>
                    <a href="https://github.com/yunfie-twitter/yt-dlp-api" target="_blank" style="color: var(--primary); text-decoration: none;">
                        GitHub リポジトリ
                    </a>
                </p>
            </div>

            <div class="settings-item">
                <h6>使用ライブラリ</h6>
                <p class="small"><i>check_circle</i> VueUse - 自動メモリ管理</p>
                <p class="small"><i>check_circle</i> Axios - 信頼性の高いHTTP</p>
                <p class="small"><i>check_circle</i> DayJS - 日付フォーマット</p>
                <p class="small"><i>check_circle</i> DOMPurify - XSS対策</p>
                <p class="small"><i>check_circle</i> ReconnectingWebSocket - 自動再接続</p>
            </div>

            <nav class="right-align" style="margin-top: 1rem;">
                <button @click="addRipple($event); showSettingsModal = false" class="primary">閉じる</button>
            </nav>
        </dialog>
    </div>

    <!-- External JS Libraries (CDN) -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.13.1/dist/cdn/beer.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
    
    <!-- Core Libraries -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/@vueuse/shared@11.3.0/index.iife.min.js"></script>
    <script src="https://unpkg.com/@vueuse/core@11.3.0/index.iife.min.js"></script>
    <script src="https://unpkg.com/axios@1.7.9/dist/axios.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.13/dayjs.min.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.13/plugin/duration.js"></script>
    <script src="https://unpkg.com/dayjs@1.11.13/plugin/relativeTime.js"></script>
    <script src="https://unpkg.com/dompurify@3.2.2/dist/purify.min.js"></script>
    <script src="https://unpkg.com/reconnecting-websocket@4.4.0/dist/reconnecting-websocket-iife.min.js"></script>
    
    <script>
        // Initialize dayjs plugins
        dayjs.extend(window.dayjs_plugin_duration)
        dayjs.extend(window.dayjs_plugin_relativeTime)
        dayjs.locale('ja')
    </script>
    
    <!-- Application JavaScript -->
    <script src="app.js"></script>
</body>
</html>
